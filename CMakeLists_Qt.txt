# CMakeLists.txt for ReactOS Qt + Vulkan Subsystem
cmake_minimum_required(VERSION 3.20)
project(ReactOS_Qt_Subsystem VERSION 1.0.0 LANGUAGES CXX)

# Set C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Qt configuration
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# Output directories
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# Find Qt6
find_package(Qt6 6.9 COMPONENTS
    Core
    Gui
    Widgets
    Quick
    REQUIRED
)

if(Qt6_FOUND)
    message(STATUS "Qt6 found: ${Qt6_VERSION}")
    message(STATUS "Qt6 Core: ${Qt6Core_VERSION}")
    message(STATUS "Qt6 Gui: ${Qt6Gui_VERSION}")
    message(STATUS "Qt6 Widgets: ${Qt6Widgets_VERSION}")
    message(STATUS "Qt6 Quick: ${Qt6Quick_VERSION}")
else()
    message(FATAL_ERROR "Qt6 not found. Please install Qt 6.9 or later.")
    message(FATAL_ERROR "Download from: https://www.qt.io/download")
endif()

# Find Vulkan
find_package(Vulkan 1.3 REQUIRED)

if(Vulkan_FOUND)
    message(STATUS "Vulkan found: ${Vulkan_VERSION}")
    message(STATUS "Vulkan Include: ${Vulkan_INCLUDE_DIRS}")
    message(STATUS "Vulkan Library: ${Vulkan_LIBRARIES}")
else()
    message(FATAL_ERROR "Vulkan SDK not found. Please install Vulkan SDK 1.3 or later.")
    message(FATAL_ERROR "Download from: https://vulkan.lunarg.com/")
endif()

# Compiler flags
if(MSVC)
    add_compile_options(/W4 /WX)
    add_compile_options(/utf-8)  # Use UTF-8 encoding
    # Enable modern C++ features
    add_compile_options(/permissive-)
else()
    add_compile_options(-Wall -Wextra -Werror)
    add_compile_options(-Wpedantic)
endif()

# Debug/Release configurations
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    message(STATUS "Building in Debug mode")
    add_compile_definitions(QT_DEBUG)
    if(MSVC)
        add_compile_options(/Od /Zi)
    else()
        add_compile_options(-O0 -g)
    endif()
else()
    message(STATUS "Building in Release mode")
    add_compile_definitions(QT_NO_DEBUG_OUTPUT)
    if(MSVC)
        add_compile_options(/O2)
    else()
        add_compile_options(-O2)
    endif()
endif()

# Enable testing
option(BUILD_TESTING "Build tests" ON)
if(BUILD_TESTING)
    enable_testing()
    find_package(Qt6 COMPONENTS Test REQUIRED)
endif()

# Qt Framework
add_subdirectory(src/qt_framework)

# System Components
option(BUILD_EXPLORER "Build Qt Explorer" ON)
option(BUILD_TASKBAR "Build Qt Taskbar" ON)
option(BUILD_CONTROL_PANEL "Build Qt Control Panel" ON)
option(BUILD_SETTINGS "Build Qt Settings" ON)

if(BUILD_EXPLORER)
    add_subdirectory(src/explorer)
endif()

if(BUILD_TASKBAR)
    add_subdirectory(src/taskbar)
endif()

if(BUILD_CONTROL_PANEL)
    add_subdirectory(src/control_panel)
endif()

if(BUILD_SETTINGS)
    add_subdirectory(src/settings)
endif()

# Applications
option(BUILD_APPS "Build Qt Applications" ON)
if(BUILD_APPS)
    add_subdirectory(src/apps/notepad)
    add_subdirectory(src/apps/paint)
    add_subdirectory(src/apps/calculator)
    add_subdirectory(src/apps/taskmanager)
endif()

# Tests
if(BUILD_TESTING)
    add_subdirectory(tests)
endif()

# Installation
install(DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/
    DESTINATION bin
    FILES_MATCHING PATTERN "*.exe"
)

install(DIRECTORY ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/
    DESTINATION lib
    FILES_MATCHING PATTERN "*.dll"
)

# Summary
message(STATUS "")
message(STATUS "========================================")
message(STATUS "ReactOS Qt + Vulkan Subsystem Configuration")
message(STATUS "========================================")
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Qt version: ${Qt6_VERSION}")
message(STATUS "Vulkan version: ${Vulkan_VERSION}")
message(STATUS "C++ standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Explorer: ${BUILD_EXPLORER}")
message(STATUS "Build Taskbar: ${BUILD_TASKBAR}")
message(STATUS "Build Control Panel: ${BUILD_CONTROL_PANEL}")
message(STATUS "Build Settings: ${BUILD_SETTINGS}")
message(STATUS "Build Applications: ${BUILD_APPS}")
message(STATUS "Build Testing: ${BUILD_TESTING}")
message(STATUS "========================================")
message(STATUS "")
